<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Mecalc – Normas & Catálogos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./styles.css" />

  <style>
    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 10px;
      margin-bottom: 14px;
    }
    @media (max-width: 900px){
      .row{ grid-template-columns: 1fr; }
    }
    .field label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
      font-weight: 800;
    }
    .field select{
      width:100%;
      height: 40px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,.22);
      color: var(--title);
      padding: 0 12px;
      font-weight: 800;
      outline: none;
    }

    .pdf-wrap{
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.08);
      overflow: hidden;
      background: rgba(0,0,0,.18);
    }
    .pdf-embed{
      width: 100%;
      height: 78vh;
      border: 0;
      display: block;
      background: rgba(0,0,0,.18);
    }

    .chips{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 12px;
    }
    .chip{
      display:inline-block;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color: rgba(255,255,255,.90);
      text-decoration:none;
      font-size: 12px;
      font-weight: 800;
    }
    .chip:hover{ filter: brightness(1.05); }

    .note{
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.5;
    }
    .warn{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,213,74,.35);
      background: rgba(255,213,74,.06);
      color: rgba(255,255,255,.88);
      font-size: 12px;
      line-height: 1.5;
      display:none;
    }
  </style>
</head>

<body>

<header class="top">
  <div class="wrap">
    <h1>Mecalc</h1>
    <nav class="main-nav">
      <a href="./home.html">Home</a>
      <a href="./index.html">Pneumática</a>
      <a href="./transportadores.html">Transportadores</a>
      <a href="./cames.html">Cames</a>
      <a href="./normas.html" class="active">Normas</a>
    </nav>
  </div>
</header>

<main class="wrap">

  <section class="card">
    <h2>Normas & Catálogos</h2>
    <p class="para">
      Biblioteca rápida de normas (PDF) para consulta. Use os filtros abaixo.
    </p>

    <div class="row">
      <div class="field">
        <label for="categoria">Categoria</label>
        <select id="categoria"></select>
      </div>
      <div class="field">
        <label for="norma">Norma</label>
        <select id="norma"></select>
      </div>
    </div>

    <div class="pdf-wrap">
      <iframe id="pdfViewer" class="pdf-embed" src="" title="Norma PDF"></iframe>
    </div>

    <div class="chips">
      <a class="chip" id="openPdf" href="#" target="_blank" rel="noreferrer">Abrir PDF</a>
    </div>

    <div class="note">
      Dica: use <b>Ctrl + F</b> no PDF para buscar por diâmetro/medida.
    </div>

    <div id="pdfWarn" class="warn">
      Não foi possível carregar o PDF no viewer. Use o botão <b>“Abrir PDF”</b>.
      Se der 404, confirme o caminho do arquivo dentro de <code>assets/pdf/</code>.
    </div>

  </section>

</main>

<script>
  // =========================
  //  Cadastro central das normas
  // =========================
  const NORMAS = [
    {
      categoria: "Anéis elásticos",
      itens: [
        { nome: "DIN 471 — Anel para eixo (externo)", path: "./assets/pdf/aneis/din-471.pdf" },
        { nome: "DIN 472 — Anel para furo (interno)", path: "./assets/pdf/aneis/din-472.pdf" },
      ]
    },
    {
      categoria: "Chavetas",
      itens: [
        { nome: "DIN 6885 — Chaveta paralela", path: "./assets/pdf/chavetas/din-6885.pdf" },
      ]
    }
  ];

  // =========================
  //  Helpers
  // =========================
  const categoriaSel = document.getElementById("categoria");
  const normaSel = document.getElementById("norma");
  const viewer = document.getElementById("pdfViewer");
  const openBtn = document.getElementById("openPdf");
  const warn = document.getElementById("pdfWarn");

  const LS_CAT = "mecalc_normas_categoria";
  const LS_NORMA = "mecalc_normas_norma";

  function uniqueCategorias(){
    // evita duplicatas se no futuro repetir categorias
    return Array.from(new Set(NORMAS.map(x => x.categoria)));
  }

  function getCategoriaObj(nome){
    return NORMAS.find(x => x.categoria === nome);
  }

  function findNormaByName(catObj, normaName){
    if(!catObj) return null;
    return catObj.itens.find(it => it.nome === normaName) || null;
  }

  function fillCategorias(selected){
    categoriaSel.innerHTML = "";
    const cats = uniqueCategorias();
    cats.forEach((c) => {
      const opt = document.createElement("option");
      opt.value = c;
      opt.textContent = c;
      categoriaSel.appendChild(opt);
    });

    // seleciona se existir, senão primeira
    categoriaSel.value = cats.includes(selected) ? selected : cats[0];
  }

  function fillNormas(catNome, selectedNormaName){
    normaSel.innerHTML = "";
    const cat = getCategoriaObj(catNome);
    if(!cat || !cat.itens || cat.itens.length === 0) return;

    cat.itens.forEach((it) => {
      const opt = document.createElement("option");
      opt.value = it.path;
      opt.textContent = it.nome;
      normaSel.appendChild(opt);
    });

    // tenta selecionar por nome; senão primeira
    const byName = findNormaByName(cat, selectedNormaName);
    if(byName){
      normaSel.value = byName.path;
    }else{
      normaSel.value = cat.itens[0].path;
    }
  }

  function setUrlParams(cat, normaName){
    const url = new URL(window.location.href);
    url.searchParams.set("cat", cat);
    url.searchParams.set("norma", normaName);
    window.history.replaceState({}, "", url.toString());
  }

  function getUrlParams(){
    const url = new URL(window.location.href);
    return {
      cat: url.searchParams.get("cat") || "",
      norma: url.searchParams.get("norma") || ""
    };
  }

  async function headOk(url){
    try{
      const r = await fetch(url, { method: "HEAD" });
      return r.ok;
    }catch(e){
      return false;
    }
  }

  async function setViewer(path){
    viewer.src = path;
    openBtn.href = path;

    // check simples (se falhar, mostra aviso)
    const ok = await headOk(path);
    warn.style.display = ok ? "none" : "block";
  }

  function currentNormaName(){
    const opt = normaSel.options[normaSel.selectedIndex];
    return opt ? opt.textContent : "";
  }

  function persistSelection(){
    localStorage.setItem(LS_CAT, categoriaSel.value);
    localStorage.setItem(LS_NORMA, currentNormaName());
    setUrlParams(categoriaSel.value, currentNormaName());
  }

  // =========================
  //  Eventos
  // =========================
  categoriaSel.addEventListener("change", async () => {
    fillNormas(categoriaSel.value, "");
    await setViewer(normaSel.value);
    persistSelection();
  });

  normaSel.addEventListener("change", async () => {
    await setViewer(normaSel.value);
    persistSelection();
  });

  // =========================
  //  Init (prioridade: URL > localStorage > padrão)
  // =========================
  (async function init(){
    const qp = getUrlParams();
    const savedCat = localStorage.getItem(LS_CAT) || "";
    const savedNorma = localStorage.getItem(LS_NORMA) || "";

    const initCat = qp.cat || savedCat || uniqueCategorias()[0];
    const initNormaName = qp.norma || savedNorma || "";

    fillCategorias(initCat);
    fillNormas(categoriaSel.value, initNormaName);

    await setViewer(normaSel.value);
    persistSelection();
  })();
</script>

</body>
</html>

